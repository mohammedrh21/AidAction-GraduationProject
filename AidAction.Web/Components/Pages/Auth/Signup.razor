@page "/Auth/Signup"
@layout SecondaryLayout
@inject IMainWebsite _mainWebsite
@inject IAuthService _auth
@inject IAuthRepository _authRep
@inject NavigationManager _nav
@inject IJSRuntime JS
@inject CustomAuthStateProvider Provider

@using Microsoft.AspNetCore.Components.Forms
@rendermode InteractiveServer

<div class="login-body">
    @if (showMessage)
    {

        if (dBResult.rv != null)
        {
            if (dBResult.rv != null)
            {
                <div style="position:absolute;top:250px; left:250px;" class="alert @(dBResult.rv == "1" ? "alert-success" : "alert-danger")">
                    @(dBResult.rv == "1" ? "Registration success, Redirecting..." : dBResult.Msg)
                </div>
            }
        }
    }
    <div class="signup-wrapper">
        <div class="signup-container w-25 d-flex align-items-center justify-content-center flex-column py-2">
            <h2>Sign Up - Aid Action</h2>

            <!-- Using Blazor's EditForm and binding the data to SignUpModel -->
            <EditForm Model="Donor" OnValidSubmit="DonorSaveAsync" FormName="SignUpForm" class="d-flex justify-content-center flex-column">
                <!-- First Name Field -->
                <div class="input-group">
                    <label for="firstName"><i class="fas fa-user"></i> First Name</label>
                    <InputText @bind-Value="Donor.FirstName" placeholder="Enter your first name" required />
                </div>

                <!-- Last Name Field -->
                <div class="input-group">
                    <label for="lastName"><i class="fas fa-user"></i> Last Name</label>
                    <InputText @bind-Value="Donor.LastName" placeholder="Enter your last name" required />
                </div>

                <!-- Email Field -->
                <div class="input-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email</label>
                    <InputText @bind-Value="Donor.Email" type="email" placeholder="Enter your email" required />
                </div>

                <!-- Password Field -->
                <div class="input-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <InputText @bind-Value="Donor.Password" type="password" placeholder="Enter your password" required />
                </div>

                <!-- Date of Birth Field -->
                <div class="input-group">
                    <label for="dob"><i class="fas fa-calendar-alt"></i> Date of Birth</label>
                    <InputDate @bind-Value="Donor.DOB" required />
                </div>

                <button type="submit" class="signup-btn text-left w-50">Sign Up</button>
            </EditForm>

            <!-- Links section -->
            <div class="links">
                <NavLink href="/Auth/Login" class="login-link"><i class="fas fa-sign-in-alt"></i> Already have an account?</NavLink>
            </div>
        </div>
    </div>


</div>

@code {
    bool showMessage = false;
    [SupplyParameterFromForm]
    public DonorSaveDTO Donor { get; set; } = new DonorSaveDTO() { DOB = DateTime.Now };

    DBResult dBResult = new DBResult();

    private async Task DonorSaveAsync()
    {
        DonorModel _donor = new DonorModel()
            {
                DOB = Donor.DOB,
                FirstName = Donor.FirstName,
                LastName = Donor.LastName,
                Email = Donor.Email,
                Password = Donor.Password,
                ConfirmPassword = Donor.Password
            };

        var result = await _mainWebsite.DonorSaveAsync(_donor);
        if (result != null)
        {
            dBResult = Newtonsoft.Json.JsonConvert.DeserializeObject<DBResult>(result.ToString());

            if (int.Parse(dBResult.rv) > 0)
            {
                var authResult = await AuthenticateAsync(dBResult);
                if (authResult.IsAuthenticated)
                {
                    showMessage = true;
                    StateHasChanged();
                    await Task.Delay(1000);
                    Provider.token = authResult.Token;
                    JS.InvokeVoidAsync("localStorage.setItem", "Token", authResult.Token);
                    JS.InvokeVoidAsync("localStorage.setItem", "FullName", authResult.FullName);
                    JS.InvokeVoidAsync("localStorage.setItem", "UserType", authResult.UserType);
                    JS.InvokeVoidAsync("localStorage.setItem", "Username", authResult.Username);

                    Provider.SetUserAsync(authResult.Token, authResult.UserType, authResult.FullName);

                    await Task.Delay(500);

                    _nav.NavigateTo("/");
                }
            }
            else
            {
                showMessage = true; // Show the failure message
                StateHasChanged(); // Update the UI to display the failure message
            }
        }
        else
        {
            dBResult.rv = "-1";
            dBResult.Msg = "Internal Server Error";
            showMessage = true; // Show the failure message
            StateHasChanged(); // Update the UI to display the error
        }
    }


    private async Task<AuthModel> AuthenticateAsync(DBResult _dBResult)
    {
        var result = await _auth.AuthenticateAsync(_dBResult);
        if (result.IsAuthenticated)
        {
            await _authRep.SaveTokenAsync(new { result.UserId, result.UserType, result.Token });
        }
        return result;
    }
}
