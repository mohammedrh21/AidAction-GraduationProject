@page "/"
@inject IJSRuntime JS
@inject NavigationManager _Nav
@layout MainLayout
@inject IMainWebsite _Main
@inject CustomAuthStateProvider AuthStateProvider

<PageTitle>Home</PageTitle>

<!-- 🔹 Hero Section -->
<section class="hero-section d-flex align-items-center text-center text-white">
    <div class="container" id="hero">
        <h1 class="display-4 fw-bold">
            Fund <span class="text-light">Help Others</span>
        </h1>
        <p class="lead">
            Your donations change lives. Start fundraising today.
        </p>
        <NavLink href="/MainWebsite/DonationCenter" class="btn btn-success btn-lg">Start Donation</NavLink>
    </div>
</section>

<!-- about our camp  -->
<!-- 🔹 About Our Camp Section -->
<section class="about-camp-section py-5" id="about">
    <div class="container text-center">
        <h2 class="fw-bold">
            About Our Camp:
            <span class="text-success">Supporting Refugees in Need</span>
        </h2>
        <p class="text-muted">
            Our mission is to provide essential services for those in need within
            the camp, including food, water, shelter, and healthcare.
        </p>
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="p-4 shadow-sm rounded">
                    <h4 class="text-success">Essential Supplies</h4>
                    <p>
                        Providing food, clean water, and medical supplies to improve
                        living conditions.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-4 shadow-sm rounded">
                    <h4 class="text-success">Shelter & Safety</h4>
                    <p>
                        Ensuring refugees have safe, secure shelters to protect them
                        from harsh conditions.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-4 shadow-sm rounded">
                    <h4 class="text-success">Health & Care</h4>
                    <p>
                        Offering access to healthcare services to maintain the
                        well-being of camp residents.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 🔹 Statistics Section -->
<section class="statistics-section py-5 bg-light">
    <div class="container text-center">
        <h2 class="fw-bold mb-4">Our Impact in Numbers</h2>
        <div class="row">
            <!-- Total Donations -->
            <div class="col-md-4 mb-4">
                <div class="d-flex flex-column align-items-center">
                    <img src="./resources/images/dollar.png" alt="total-donations" />
                    <h4 class="text-success">Total Donations</h4>
                    <h3 style="font-weight: normal">$@(main.TotalDonation)</h3>
                </div>
            </div>
            <!-- Total Donors -->
            <div class="col-md-4 mb-4">
                <div class="d-flex flex-column align-items-center Statistics">
                    <img src="./resources/images/volunteer.png"
                         alt="total-donators" />

                    <h4 class="text-success">Total Donors</h4>
                    <h3 style="font-weight: normal">@(main.TotalDonors)</h3>
                </div>
            </div>
            <!-- Emergency Donations -->
            <div class="col-md-4 mb-4"
                 style="
              display: flex;
              flex-direction: column;
              justify-content: space-around;
            ">
                <div class="d-flex flex-column align-items-center"
                     id="fund-progress">
                    <div class="mt-4">
                        <h4 class="text-success">Emergency Fund Progress</h4>
                        <div class="progress" style="height: 30px">
                            <div class="progress-bar bg-success"
                                 role="progressbar"
                                 style="width: @(main.EmergencyFundProgress)%"
                                 aria-valuenow="@(main.EmergencyFundProgress)"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                @(main.EmergencyFundProgress)%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<section class="statistics-section py-5 bg-light">
    <div class="container text-center">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <h2 class="fw-bold text-success mb-0">Urgent Needs Fundraising!</h2>
        </div>
        <div class="row">
            @if (main.Needs != null)
            {
                @foreach (var need in main.Needs)
                {
                    <div class="col-md-4 mb-3">
                        <div class="shadow-sm rounded p-3">
                            <img src="@need.ImagePath"
                                 class="img-fluid rounded"
                                 alt="Need '@need.NeedId'" style="width:400px; height:300px;" />
                            <h5 class="mt-2">Disaster-Care: @need.Title</h5>
                            <p class="text-success">$@need.TotalFundsCollected Raised</p>

                            <!-- Progress Bar -->
                            <div class="progress mb-3" style="height: 20px">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: @(need.TotalFundsCollected / (need.TargetAmount ?? 1) * 100)%"
                                     aria-valuenow="30"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    @(need.TotalFundsCollected / (need.TargetAmount ?? 1) * 100)%
                                </div>
                            </div>

                            <!-- Last Donation Date -->
                            <p class="text-muted">Creation Date: @need.CreationDate</p>

                            <!-- Donate Button -->
                            <NavLink href="@GetNeedDetailsUrl(need.NeedId)" class="btn btn-success w-100">Donate</NavLink>
                        </div>
                    </div>
                }
            }

        </div>
    </div>
</section>

<!-- 🔹 Fundraising Campaigns Section -->
<section id="campaigns"
         class="urgent-fundraising py-5"
         style="background-color: rgb(237, 237, 237)">
    <div class="container text-center">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <h2 class="fw-bold text-success mb-0">Campaigns Fundraising!</h2>

        </div>
        <p class="text-muted">Uniting for a Greater Cause</p>
        <div class="row mt-4">
            @if (main.Campaigns != null)
            {
                @foreach (var campaign in main.Campaigns)
                {
                    <div class="col-md-4 mb-3">
                        <div class="shadow-sm rounded p-3">
                            <img src="@campaign.ImagePath"
                                 class="img-fluid rounded"
                                 alt="Campaign '@campaign.CampaignId'" style="width:400px; height:300px;" />
                            <h5 class="mt-2">@campaign.Title</h5>
                            <p class="text-success">$@campaign.TotalFundCollected Raised</p>

                            <!-- Progress Bar -->
                            <div class="progress mb-3" style="height: 20px">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: @(campaign.TotalFundCollected / (campaign.TargetAmount ?? 1) * 100)%"
                                     aria-valuenow="30"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    @(campaign.TotalFundCollected / (campaign.TargetAmount ?? 1) * 100)%
                                </div>
                            </div>

                            <!-- Last Donation Date -->
                            <p class="text-muted">Approved Date: @campaign.ApprovalDate</p>

                            <!-- Donate Button -->
                            <NavLink href="@GetCampaignDetailsUrl(campaign.CampaignId)" class="btn btn-success w-100">Donate</NavLink>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</section>
@code {
    private int index;
    private bool isAuthenticated;
    public MainWebsite main { get; set; } = new MainWebsite();
    public WebsiteDetails website { get; set; } = new WebsiteDetails();

    private string GetCampaignDetailsUrl(int campaignId)
    {
        return $"/MainWebsite/CampaignDetails/?campaignId={campaignId}";
    }

    public async Task MainWebsiteSelectAsync()
    {

        var result = await _Main.MainWebsiteSelectAsync();
        var resultData = Newtonsoft.Json.JsonConvert.DeserializeObject<Result<List<MainWebsite>>>(result.ToString());
        main = resultData.Data.FirstOrDefault();
        StateHasChanged(); // Trigger re-render to update UI with the new data

    }

    public async Task WebsiteDetailsSelectAsync()
    {

        var result = await _Main.WebsiteDetailsSelectAsync();
        var resultDataList = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Result<List<WebsiteDetails>>>>(result.ToString());

        // Get the first item from the list (since it’s an array in the JSON root)
        var resultData = resultDataList.FirstOrDefault();

        // Check if the result is not null
        if (resultData != null)
        {
            // Access the list of WebsiteDetails
            List<WebsiteDetails> websiteDetailsList = resultData.Data;
            website = websiteDetailsList.FirstOrDefault();
        }
        StateHasChanged(); // Trigger re-render to update UI with the new data
    }

    protected override async Task OnInitializedAsync()
    {
        await MainWebsiteSelectAsync();
        await WebsiteDetailsSelectAsync();
        string token = AuthStateProvider.token;
        if (!string.IsNullOrEmpty(AuthStateProvider.token))
        {
            isAuthenticated = true;
        }
    }



    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "Token");
        await JS.InvokeVoidAsync("localStorage.removeItem", "UserId");
        await JS.InvokeVoidAsync("localStorage.removeItem", "UserType");

        await Task.Delay(200);
        await AuthStateProvider.LogoutAsync();
        isAuthenticated = false;
        StateHasChanged();
        _Nav.Refresh();
        StateHasChanged();
    }

    // Generate the URL for need details
    private string GetNeedDetailsUrl(int NeedId)
    {
        return $"/MainWebsite/NeedDetails/?NeedId={NeedId}";
    }
}